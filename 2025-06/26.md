# ğŸ§µ ThreadLocal ë™ì‘ ì›ë¦¬ì™€ JVM êµ¬ì¡°
ğŸ“… 2025-06-26  
ğŸ” ê³µë¶€í•œ ë‚´ìš©: Javaì˜ ThreadLocal ì‘ë™ ë°©ì‹ê³¼ JVM ë©”ëª¨ë¦¬ êµ¬ì¡°  
ğŸ“š ì°¸ê³ ìë£Œ: ChatGPT ì„¤ëª… ìš”ì•½

---

## âœ… ThreadLocalì´ë€?

ThreadLocalì€ **ê° ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ì¸ ë³€ìˆ˜ ê³µê°„ì„ ì œê³µ**í•˜ì—¬, 
ë™ì¼í•œ ThreadLocal ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ **ë‹¤ë¥¸ ìŠ¤ë ˆë“œ ê°„ ê°’ì´ ê³µìœ ë˜ì§€ ì•Šë„ë¡** í•©ë‹ˆë‹¤.

```java
public class SessionContextHolder {
    private static final ThreadLocal<Long> userIdHolder = new ThreadLocal<>();

    public static void set(Long userId) {
        userIdHolder.set(userId);
    }

    public static Long get() {
        return userIdHolder.get();
    }

    public static void clear() {
        userIdHolder.remove(); // memory leak ë°©ì§€!
    }
}
```

---

## ğŸ§  JVM êµ¬ì¡°ì—ì„œ ThreadLocal ì €ì¥ ìœ„ì¹˜

ThreadLocalì€ **JVM Stack**ì´ ì•„ë‹Œ, **Thread ê°ì²´ì˜ Heap ë©”ëª¨ë¦¬** ì•ˆì— ìˆëŠ” `ThreadLocalMap`ì— ì €ì¥ë©ë‹ˆë‹¤.

### ğŸ§± JVM ë©”ëª¨ë¦¬ êµ¬ì¡° (ìŠ¤ë ˆë“œ ê¸°ì¤€)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Heap (ê³µìœ )         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Method Area (ê³µìœ )       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Code Cache            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      ê° Threadë³„ ë©”ëª¨ë¦¬       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     Stack (ë…ë¦½ì )       â”‚â—€ ì§€ì—­ë³€ìˆ˜, í˜¸ì¶œìŠ¤íƒ
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚  PC Register (ë…ë¦½ì )    â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Native Stack (ë…ë¦½ì )    â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ThreadLocalMap (Heap)    â”‚â—€ Thread ê°ì²´ ë‚´ë¶€
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ë‚´ë¶€ êµ¬ì¡° ë° ë™ì‘ ë°©ì‹

ThreadLocal ê°ì²´ëŠ” Thread ë‚´ë¶€ì— ìˆëŠ” ThreadLocalMapì— keyë¡œ ì €ì¥ë˜ê³ , 
valueëŠ” ìš°ë¦¬ê°€ ë„£ì€ ê°’ì…ë‹ˆë‹¤.

```java
public class Thread {
    ThreadLocal.ThreadLocalMap threadLocals = null;
}
```

```java
Thread.currentThread().threadLocals.set(this, value);
```

- `ThreadLocalMap`: `WeakReference<ThreadLocal<?>> â†’ Object`
- ì¦‰, í‚¤ëŠ” ì•½í•œ ì°¸ì¡°(WeakReference), ê°’ì€ ê°•í•œ ì°¸ì¡°

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜

| í•­ëª© | ì„¤ëª… |
|------|------|
| í‚¤(ThreadLocal) | ì•½í•œ ì°¸ì¡°(WeakReference)ë¼ GC ëŒ€ìƒ |
| ê°’(Object) | ê°•í•œ ì°¸ì¡°ë¡œ ë‚¨ì•„ ìˆì–´ GC ë˜ì§€ ì•ŠìŒ |
| ëˆ„ìˆ˜ ì¡°ê±´ | ThreadLocalì´ GCë˜ì—ˆì§€ë§Œ, ê°’ì€ ë‚¨ì•„ ìˆëŠ” ìƒíƒœì—ì„œ Threadê°€ ê³„ì† ì‚´ì•„ ìˆëŠ” ê²½ìš° |

### â†’ í•´ê²° ë°©ë²•: `remove()` í˜¸ì¶œí•˜ì—¬ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

---

## âœ… ì •ë¦¬

| í•­ëª© | ì„¤ëª… |
|------|------|
| ì €ì¥ ìœ„ì¹˜ | Heap (Thread ê°ì²´ì˜ í•„ë“œë¡œ ì¡´ì¬) |
| ìŠ¤ë ˆë“œë³„ ë¶„ë¦¬ ì—¬ë¶€ | O (Threadë³„ë¡œ ê°œë³„ Map ê´€ë¦¬) |
| Stackê³¼ì˜ ê´€ê³„ | Stackì´ ì•„ë‹˜, ë³„ë„ ê³µê°„ |
| ìƒëª… ì£¼ê¸° | Threadê°€ ì‚´ì•„ ìˆëŠ” ë™ì•ˆ ìœ ì§€ |
| ì›¹ ì•± ì‚¬ìš© ì‹œ ì£¼ì˜ | ThreadPool ì¬ì‚¬ìš©ë˜ë¯€ë¡œ ë°˜ë“œì‹œ `.remove()` í˜¸ì¶œ |

---

## ğŸ”§ í™œìš© ì˜ˆì‹œ

- AOP, ì¸í„°ì…‰í„°ì—ì„œ ìœ ì € ì •ë³´ ì €ì¥
- ìš”ì²­ íŠ¸ë˜í‚¹ ID ì €ì¥
- ë¡œê·¸ MDC (Mapped Diagnostic Context) êµ¬ì„± ì‹œ

---

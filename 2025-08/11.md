# 2025-08-11 TIL

## 📚 공부한 내용
### InnoDB 내부 동작과 MVCC, 잠금, 버퍼 풀 동작 방식

- InnoDB는 MySQL에서 거의 유일한 **레코드 기반 잠금**을 제공하여 높은 동시성 처리가 가능하고 성능이 뛰어남
- 모든 테이블은 **프라이머리 키(PK)**를 기준으로 **클러스터링**되어 저장됨
  - PK 순서대로 디스크에 저장
  - 세컨더리 인덱스는 레코드 주소 대신 PK 값을 논리 주소로 사용
  - PK 기반 레인지 스캔이 매우 빠름
- PK만 데이터 저장, 세컨더리 인덱스는 PK만 보유 → 조회 시 더블 루프업 발생

---

## 💡 주요 개념들

### MVCC (Multi Version Concurrency Control)
- 잠금 없는 일관된 읽기를 제공
- Undo Log를 활용해 여러 버전의 레코드를 유지
- Isolation Level별 동작:
  - **READ UNCOMMITTED** → 커밋 안 된 데이터 읽기 가능
  - **READ COMMITTED** → Undo Log의 커밋된 버전 반환
- 대량 UPDATE + 긴 트랜잭션 + 세컨더리 인덱스 존재 시 Undo Log 폭증 가능

### 잠금
- **S-LOCK** → 다른 트랜잭션 읽기 가능
- **X-LOCK** → 읽기/쓰기 불가
- **SERIALIZABLE** → SELECT도 잠금 필요 → 동시성 떨어짐

### 데드락 감지
- `innodb_deadlock_detect`로 감지 가능
- 스레드 수 많으면 오버헤드 → OFF 후 `lock_wait_timeout` 설정 가능

### 장애 복구
- InnoDB는 서버 시작 시 미완료 트랜잭션 자동 복구
- 복구 불가 시 `innodb_force_recovery` 단계 조정
- 마지막 수단 → mysqldump로 백업 후 재생성

### InnoDB 버퍼 풀
- 디스크 데이터/인덱스 캐싱, 쓰기 지연 후 일괄 Flush
- UPDATE/INSERT/DELETE 시 Dirty Page로 표시 후 Redo Log 기록
- SELECT 시 Dirty Page 마킹 없음, 메모리 Hit 시 빠르게 조회

---

## 🔗 참고
- Real MySQL
- MySQL 공식 문서

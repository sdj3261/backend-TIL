# Today I Learned (2025-08-09)

ì´ ì €ì¥ì†ŒëŠ” ì œê°€ ë§¤ì¼ í•™ìŠµí•œ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ì •ë¦¬í•˜ê¸° ìœ„í•´ ë§Œë“  ê³µê°„ì…ë‹ˆë‹¤.

---

## ğŸ“š ê³µë¶€í•œ ë‚´ìš©

**[ê°œë°œ] ì¿ í° í”„ë¡œì íŠ¸ MSA ì „í™˜ (1) - Spring Cloud Gateway ì ìš©ê¸°**

### **1. ê¸°ì¡´ êµ¬ì¡°ì™€ ì „í™˜ í•„ìš”ì„±**
- **ê¸°ì¡´**: ëª¨ë†€ë¦¬í‹± êµ¬ì¡°ì—ì„œ ì¸ì¦, ì¿ í°, ê¸°íƒ€ ì„œë¹„ìŠ¤ ë¡œì§ì´ í•˜ë‚˜ì˜ íŒ¨í‚¤ì§€ì— í˜¼ì¬
- **ë¬¸ì œì **:
  - ì¸ì¦ ë¡œì§ì´ ì„œë¹„ìŠ¤ ê³³ê³³ì— ì¤‘ë³µ
  - ë„ë©”ì¸ ê°„ ê°•í•œ ì—°ê´€ê´€ê³„
- **ì „í™˜ ëª©í‘œ**:
  - ëª¨ë“ˆ ê°„ **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**
  - ì¸ì¦Â·ë¡œê¹… ë“± **íš¡ë‹¨ ê´€ì‹¬ì‚¬**ë¥¼ Gatewayì—ì„œ í†µí•© ì²˜ë¦¬
  - ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì€ **REST API** ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½

---

### **2. ëª¨ë“ˆ ë¶„ë¦¬**
- `api-gateway` : ì¸ì¦, ë¡œê¹… ë“± ê³µí†µ ë¡œì§ ì²˜ë¦¬
- `coupon-service` : ì¿ í° ê´€ë ¨ API
- `other-service` : ê¸°íƒ€ ì„œë¹„ìŠ¤ API
- **ê³µí†µ ì½”ë“œ ë¶„ë¦¬ ì›ì¹™**:
  - ì¸ì¦Â·ë¡œê¹… â†’ `api-gateway`
  - DTO, ErrorCode, ì˜ˆì™¸ ì²˜ë¦¬ â†’ ê° ì„œë¹„ìŠ¤ ë„ë©”ì¸ì— ë§ê²Œ ìµœì†Œí•œë§Œ í¬í•¨

---

### **3. Gateway ì„¤ì •**
```yaml
server:
  port: 8080

spring:
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 5000
  cloud:
    gateway:
      routes:
        - id: coupon-service
          uri: http://localhost:8081
          predicates:
            - Path=/coupons/**
          filters:
            - StripPrefix=1
        - id: other-service
          uri: http://localhost:8082
          predicates:
            - Path=/others/**
          filters:
            - StripPrefix=1
```
- **id** : ë¼ìš°íŒ… ì‹ë³„ì (ì„œë¹„ìŠ¤ëª…)
- **uri** : ìš”ì²­ì„ ì „ë‹¬í•  ì„œë¹„ìŠ¤ ì£¼ì†Œ
- **predicates** : ê²½ë¡œ ë§¤ì¹­ ì¡°ê±´
- **filters** : ìš”ì²­ ê²½ë¡œ ì „ì²˜ë¦¬ (`StripPrefix=1`)

---

### **4. Netty ê¸°ë°˜ì˜ ë™ì‘ ë°©ì‹**
- **í†°ìº£**: ìš”ì²­ë§ˆë‹¤ ì“°ë ˆë“œ 1ê°œë¥¼ ì ìœ  â†’ Blocking I/O â†’ ìš”ì²­ ìˆ˜ ì¦ê°€ ì‹œ ì“°ë ˆë“œ í­ì¦ ë° ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ì˜¤ë²„í—¤ë“œ
- **Netty**:
  - **EventLoop ê¸°ë°˜ Non-blocking I/O**
  - Channelì„ EventLoopì— í• ë‹¹, I/O ì´ë²¤íŠ¸ë¥¼ íì‰
  - í•˜ë‚˜ì˜ EventLoopê°€ ì—¬ëŸ¬ ì±„ë„ì„ ì²˜ë¦¬
  - ì“°ë ˆë“œ ì ìœ  ì‹œê°„ì„ ìµœì†Œí™”í•˜ì—¬ ë†’ì€ RPS ì²˜ë¦¬ì— ìœ ë¦¬

---

### **5. ì¸ì¦ í•„í„° êµ¬í˜„ (AuthGatewayFilter.java)**
```java
@Component
@RequiredArgsConstructor
public class AuthGatewayFilter implements GlobalFilter, Ordered {
    private final StringRedisTemplate redisTemplate;
    private final ObjectMapper objectMapper;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String authHeader = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            return onUnauthorized(exchange, "í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        String sessionId = authHeader.substring(7);
        String redisKey = "SESSION:" + sessionId;

        return Mono.fromCallable(() -> redisTemplate.opsForValue().get(redisKey))
                .flatMap(sessionJson -> {
                    if (sessionJson == null) {
                        return onUnauthorized(exchange, "ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    try {
                        UserSessionDto session = objectMapper.readValue(sessionJson, UserSessionDto.class);
                        ServerHttpRequest mutated = exchange.getRequest().mutate()
                                .header("X-USER-ID", String.valueOf(session.id()))
                                .header("X-USER-EMAIL", session.email())
                                .header("X-USER-ROLE", session.roles().get(0))
                                .build();
                        return chain.filter(exchange.mutate().request(mutated).build());
                    } catch (Exception e) {
                        return onUnauthorized(exchange, "ì„¸ì…˜ íŒŒì‹± ì‹¤íŒ¨");
                    }
                })
                .switchIfEmpty(onUnauthorized(exchange, "ì¸ì¦ ì‹¤íŒ¨"));
    }

    private Mono<Void> onUnauthorized(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        exchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON);
        String body = "{\"error\":\"" + message + "\"}";
        DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8));
        return exchange.getResponse().writeWith(Mono.just(buffer));
    }

    @Override
    public int getOrder() {
        return -1; // ê°€ì¥ ë¨¼ì € ì‹¤í–‰
    }
}
```
- **Redis ê¸°ë°˜ ì„¸ì…˜ ê²€ì¦**
- ì¸ì¦ ì„±ê³µ ì‹œ ìœ ì € ì •ë³´ë¥¼ HTTP í—¤ë”ì— ì‹¤ì–´ downstream ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬
- ì¸ì¦ ì‹¤íŒ¨ ì‹œ `401 Unauthorized` ë°˜í™˜

---

### **6. ì •ë¦¬**
- **Spring Cloud Gateway**:
  - ë¹„ë™ê¸° ë…¼ë¸”ë¡œí‚¹ I/O â†’ ê³ ì„±ëŠ¥ API ì¤‘ê³„
  - íš¡ë‹¨ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ì— ìµœì 
  - ì„œë¹„ìŠ¤ ì¶”ìƒí™”ë¡œ í´ë¼ì´ì–¸íŠ¸-ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ ê°ì†Œ
- **ì „í™˜ íš¨ê³¼**:
  - ì½”ë“œ ì¤‘ë³µ ì œê±°
  - ì„œë¹„ìŠ¤ ë…ë¦½ì„± í™•ë³´
  - í™•ì¥Â·ì¥ì•  ëŒ€ì‘ë ¥ í–¥ìƒ

---

## ğŸ”— ì°¸ê³ 
- [Spring Cloud Gateway Docs](https://spring.io/projects/spring-cloud-gateway)
- [Netty Docs](https://netty.io/wiki/user-guide-for-4.x.html)

# 2025-08-13 TIL

## 📚 공부한 내용
- `@TransactionalEventListener`와 트랜잭션 이벤트 동작 시점
- `@Transactional`의 철학, 내부 동작 원리, 프록시 생성 시점
- Spring AOP 기반 트랜잭션 처리 과정과 ThreadLocal 커넥션 동기화

---

## 💡 주요 개념들

### 1. `@TransactionalEventListener` 이벤트 호출 시점
- **AFTER_COMMIT**  
  - 기존 트랜잭션이 정상적으로 **커밋된 직후** 호출
  - 커밋 실패 시 호출되지 않음  
- **AFTER_COMPLETION**  
  - 기존 트랜잭션이 **종료된 직후** 호출 (커밋/롤백 여부와 관계 없음)  
- 이벤트 시점은 주로 비동기 처리나 후속 작업, 보상 로직에 활용

---

### 2. `@Transactional` 철학
- **목적**: 비즈니스 로직 실행 시 데이터 **일관성**과 **무결성** 보장
- **ACID 속성 준수**:
  - Atomicity: 전부 실행 또는 전부 취소
  - Consistency: 트랜잭션 전후 데이터 무결성 유지
  - Isolation: 다른 트랜잭션 간 간섭 방지
  - Durability: 커밋된 데이터 영구 보존
- **철학**: "비즈니스 단위는 하나의 트랜잭션 경계 안에서 완결"

---

### 3. 내부 동작 구조
1. **프록시 생성 시점**
   - Spring이 Bean 초기화 직후(`postProcessAfterInitialization`)에 AOP 적용 여부를 검사
   - 프록시로 감싸서 반환 (싱글톤이면 컨텍스트 시작 시, `@Lazy`나 프로토타입이면 실제 호출 시)
   
2. **호출 흐름**
   ```
   클라이언트 → 프록시 → TransactionInterceptor(@Transactional 메타데이터 조회)
   → PlatformTransactionManager.getTransaction()
   → 필요 시 새 트랜잭션 시작 (auto-commit off, 격리수준/읽기전용 설정)
   → 커넥션/리소스를 ThreadLocal에 바인딩
   → 실제 메서드 실행
   → 정상 종료 → commit()
   → 예외 발생 → rollback() (기본: Unchecked 예외)
   → ThreadLocal 해제 + 동기화 콜백 호출(beforeCommit, afterCommit, afterCompletion)
   ```

3. **ThreadLocal 기반 커넥션 관리**
   - 하나의 스레드에서 하나의 커넥션을 유지
   - 같은 트랜잭션 경계 안에서는 동일 커넥션을 재사용
   - 트랜잭션 전파(Propagation) 판단 기준도 현재 스레드 ThreadLocal

---

### 4. 전파 옵션(Propagation)
- `REQUIRED` (기본): 기존 트랜잭션 있으면 참여, 없으면 새로 시작
- `REQUIRES_NEW`: 무조건 새 트랜잭션 (기존 중단)
- `NESTED`: 부모 트랜잭션 내에서 중첩 실행
- `NOT_SUPPORTED`: 트랜잭션 없이 실행
- `MANDATORY`: 반드시 트랜잭션 존재해야 함

---

### 5. `@TransactionalEventListener` 제약 (Spring 6.x)
- `@TransactionalEventListener` 메서드에 `@Transactional`을 붙이는 경우  
  **`REQUIRES_NEW`** 또는 **`NOT_SUPPORTED`** 전파만 허용
- 이유: 이벤트 처리는 커밋 이후 실행이 일반적이므로, 기존 트랜잭션 롤백에 영향받지 않게 설계

---

## 🛠 실습 예시
```java
// 잘못된 예시
@TransactionalEventListener
@Transactional
public void handleEvent(MyEvent event) { ... }

// 수정된 예시
@TransactionalEventListener
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void handleEvent(MyEvent event) { ... }
```

---

## 🔗 참고
- [Spring Docs - TransactionalEventListener](https://docs.spring.io/spring-framework/reference/data-access/transaction/event.html)  
- [Spring Docs - Declarative Transaction Management](https://docs.spring.io/spring-framework/reference/data-access/transaction/declarative.html)

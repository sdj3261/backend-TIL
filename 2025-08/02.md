# Today I Learned (2025-08-02)

ì´ ì €ì¥ì†ŒëŠ” ì œê°€ ë§¤ì¼ í•™ìŠµí•œ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ì •ë¦¬í•˜ê¸° ìœ„í•´ ë§Œë“  ê³µê°„ì…ë‹ˆë‹¤. ê¸°ìˆ ì ì¸ ê°œë…, ì‹¤ìŠµí•˜ë©´ì„œ ë§ˆì£¼ì¹œ ë¬¸ì œë“¤, ì •ë¦¬í•˜ê³  ì‹¶ì€ ê°œë…ë“¤ì„ ì£¼ì œë³„/ì¼ìë³„ë¡œ êµ¬ì¡°í™”í•˜ì—¬ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“š ê³µë¶€í•œ ë‚´ìš©

**[CS] AMQP & Spring ë©”ì‹œì§€ í ë„ì…í•˜ê¸°**

### AMQPë€?

- AMQP: Advanced Message Queuing Protocol
- OSì˜ ë©”ì‹œì§€í ê°œë…ì„ ë„¤íŠ¸ì›Œí¬ë¡œ í™•ì¥í•œ **ë©”ì‹œì§€ ì§€í–¥ í”„ë¡œí† ì½œ**
- ì£¼ìš” íŠ¹ì§•: ë©”ì‹œì§€ ì§€í–¥, íì‰, ë¼ìš°íŒ…, ë°œí–‰-êµ¬ë… ë˜ëŠ” P2P, **ì‹ ë¢°ì„±**, ë³´ì•ˆ

### ë©”ì‹œì§€ êµ¬ì„± ìš”ì†Œ

- **Publisher**: ë©”ì‹œì§€ë¥¼ ë°œí–‰
- **Exchange**: ë©”ì‹œì§€ë¥¼ ë¼ìš°íŒ…
- **Queue**: ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ëŠ” ê³µê°„
- **Binding**: Exchange â†’ Queue ì—°ê²°
- **Consumer**: íì—ì„œ ë©”ì‹œì§€ë¥¼ êº¼ë‚´ ì†Œë¹„

### Exchange íƒ€ì…

1. **Direct**: ì •í™•í•œ ë¼ìš°íŒ… í‚¤ë¡œ ë§¤í•‘
2. **Topic**: ì™€ì¼ë“œì¹´ë“œ ê¸°ë°˜ ë¼ìš°íŒ…
3. **Fanout**: ë¼ìš°íŒ… í‚¤ ë¬´ì‹œ, ëª¨ë“  íë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
4. **Headers**: ë©”ì‹œì§€ Header ê°’ ê¸°ë°˜ ë¼ìš°íŒ…

---

## ğŸ›  Spring Boot ì ìš© ì˜ˆì‹œ

### ì˜ì¡´ì„± ì¶”ê°€

```groovy
implementation 'org.springframework.boot:spring-boot-starter-amqp'
```

### ì„¤ì • ì½”ë“œ (TopicExchange ê¸°ì¤€)

```java
@Configuration
public class RabbitConfig {
    public static final String QUEUE_NAME = "order.queue";
    public static final String EXCHANGE_NAME = "order.exchange";
    public static final String ROUTING_KEY = "order.created";

    @Bean
    public Queue queue() {
        return new Queue(QUEUE_NAME);
    }

    @Bean
    public TopicExchange exchange() {
        return new TopicExchange(EXCHANGE_NAME);
    }

    @Bean
    public Binding binding(Queue queue, TopicExchange exchange) {
        return BindingBuilder.bind(queue).to(exchange).with(ROUTING_KEY);
    }
}
```

### ë©”ì‹œì§€ ë°œí–‰

```java
@RequiredArgsConstructor
@Service
public class OrderPublisher {
    private final RabbitTemplate rabbitTemplate;

    public void publishOrderCreated(OrderDto orderDto) {
        rabbitTemplate.convertAndSend(
            RabbitConfig.EXCHANGE_NAME,
            RabbitConfig.ROUTING_KEY,
            orderDto
        );
    }
}
```

### ë©”ì‹œì§€ ìˆ˜ì‹ 

```java
@RabbitListener(queues = RabbitConfig.QUEUE_NAME)
public void handleOrderCreated(OrderDto orderDto) {
    System.out.println("Received order: " + orderDto);
}
```

---

## â“ì™œ ë©”ì‹œì§€íì¸ê°€?

- **Buffer ì—­í• **: Consumerê°€ ëŠë ¤ë„ Queueì— ë²„í¼ë§ ê°€ëŠ¥ (TCP íë¦„ì œì–´ì™€ ìœ ì‚¬)
- **ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ ê°ì†Œ**: ë°œí–‰ìëŠ” ì†Œë¹„ìë¥¼ ì•Œ í•„ìš” ì—†ìŒ
- **íŠ¸ë˜í”½ ìŠ¤íŒŒì´í¬ í¡ìˆ˜**: Consumer ì¸ìŠ¤í„´ìŠ¤ í™•ì¥ìœ¼ë¡œ ëŒ€ì‘
- \*\*DLQ(Dead Letter Queue)\*\*ë¡œ ì‹¤íŒ¨ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ìš©ì´
- **RESTì™€ ì°¨ë³„ì **: ì‹¤íŒ¨ ì‹œ ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ë¶ˆí•„ìš”, íì—ì„œ êº¼ë‚´ ì¬ì‹œë„ ê°€ëŠ¥

---

## ğŸ’¥ Dead Letter Queue (DLQ)

- ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë¥¼ ì¼ì‹œ ì €ì¥í•˜ëŠ” íŠ¹ìˆ˜ í

### ì–¸ì œ ì‚¬ìš©?

- ìˆœì„œ ì˜ì¡´ ì—†ê±°ë‚˜ FIFO ìƒí™©ì—ì„œ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ê²©ë¦¬í•˜ê³ ì í•  ë•Œ

### ì¬ì²˜ë¦¬ ë°©ë²•

1. **ìˆ˜ë™ ì¬ì²˜ë¦¬ (Admin UI)**
2. **@RabbitListener + ì¡°ê±´ ì¬ë°œí–‰**

```java
@RabbitListener(queues = "my.queue.dlq")
public void processDeadLetter(String msg) {
    if (canRetry(msg)) {
        rabbitTemplate.convertAndSend("original.exchange", "original.routing.key", msg);
    } else {
        log.warn("Discard message: {}", msg);
    }
}
```

3. **@Scheduled ë°°ì¹˜ ì¬ì²˜ë¦¬**

```java
@Scheduled(fixedDelay = 60000)
public void reprocessDlqMessages() {
    List<String> failedMessages = dlqRepository.findAll();
    for (String msg : failedMessages) {
        rabbitTemplate.convertAndSend("original.exchange", "original.routing.key", msg);
    }
}
```

## ğŸ”— ì°¸ê³ 

- [Dead Letter Queue - AWS ì„¤ëª…](https://aws.amazon.com/ko/what-is/dead-letter-queue/)

